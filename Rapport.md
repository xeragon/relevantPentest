# Test de pénétration : [Relevant](https://tryhackme.com/r/roomrelevant)

## 1/ Cadre de l'audit

#### Objectif Principal :
- Récupérer les flags User.txt et Root.txt, afin de confirmer l'exploitation

#### Informations complémentaires :
- Seule l'adresse IP fournie par le client entre dans le cadre de l'audit.
- Tous les outils sont autorisés mais les exploits manuels sont à privilégier.
- Localiser et noter toutes les vulnérabilités.

## 2/ Scan
- Après quelques scans avec nmap, on obtient les informations suivantes:
```
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds  Microsoft Windows Server 2008 R2 2012 microsoft-ds
3389/tcp open  ms-wbt-server Microsoft Terminal Services
Service Info: OSs: Windows, Windows Server 2008 R2 2012; CPE: cpe:/o:microsoft:windows
49663/tcp open     http    Microsoft IIS httpd 10.0
http-methods: 
    Potentially risky methods: TRACE
http-server-header: Microsoft-IIS/10.0
http-title: IIS Windows Server
49664/tcp filtered unknown
49665/tcp filtered unknown
49666/tcp filtered unknown
49667/tcp open     msrpc   Microsoft Windows RPC
49668/tcp filtered unknown
49669/tcp open     msrpc   Microsoft Windows RPC
```

## 3/ Vulnérabilité

##### MS017-010 (eternalblue)
- Windows Server 2008 semble vulnérable à EternalBlue. Bien que l'exploit ne crée pas de reverse shell, il semble faire crasher la machine, cela peut venir du "bluescreen bug".

##### SMB
- Après l'enumeration des partages SMB à l'aide de la commande `smbclient -L target_ip`, on obtient le résultat suivant:
```
     Sharename       Type      Comment
     ---------       ----      -------
     ADMIN$          Disk      Remote Admin
     C$              Disk      Default share
     IPC$            IPC       Remote IPC
     nt4wrksv        Disk      
```
- Une simple tentative de connexion avec `smbclient \\\\target_ip\\nt4wrksv` nous permet d'accéder au disque, aucun mot de passe n'est demandé !!
- Le disque nt4wrksrv est vulnérable !
- Le disque nt4wrksrv contient un fichier password.txt qui contient des noms d'utilisateurs et leurs mots de passe qui sont très facilement décodés avec la commande `base64 -d`.
    - Après décodage, on obtient:
        - Bob - !P@$$W0rD!123
        - Bill - Juw4nnaM4n420696969!$$$
- Ce disque nous permet également de planter une reverse shell sur le serveur:
    - On génère un payload et crée un listener -> put shell.aspx -> curl http://target_ip:49663/nt4wrksv/shell.aspx
    - Avec notre reverse shell, on trouve facilement le flag **User.txt** contenu sous `c:\Users\Bob\Desktop\user.txt`.
    - À partir d'une reverse shell Meterpreter, Metasploit réussit à élever nos privilèges à l'aide de la commande `getsystem` qui utilise la technique des Named Pipe Impersonation.

##### SeImpersonatePrivilege
- Ce privilège semble être accordé à tous les utilisateurs et représente une faille car c'est un vecteur d'élévation de privilège (utilisation de PrintSpoofer).
